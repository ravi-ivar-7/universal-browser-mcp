# Record & Replay Versions Analysis

This document provides an in-depth analysis of the three versions of the "Record and Replay" feature within the `universal-browser-mcp` codebase.

## Executive Summary

| Version | Status | Architecture | Key Characteristic | Usage |
| :--- | :--- | :--- | :--- | :--- |
| **V1** | **Legacy** | Linear Steps (`Step[]`) | Simple, rigid, sequential execution. | Maintained for backward compatibility. |
| **V2** | **Transitional** | DAG-based (`Node[]`, `Edge[]`) | Introduces branching/logic. Uses `control directives` for loops. | Current standard for most flows, transitioning to V3. |
| **V3** | **Next-Gen** | **Runtime Kernel** | Modular, Resilient, Plugin-based. True Graph execution. | The future engine. Features crash recovery, RPC, and managed concurrency. |

---

## Deep Dive: Version 1 (Legacy)

**Location**: [extension/entrypoints/background/record-replay/legacy-types.ts](file:///home/ravi/Desktop/Auto%20Job%20Apply/universal-browser-mcp/extension/entrypoints/background/record-replay/legacy-types.ts)

### Architecture & Data Model
V1 is built on a **Linear Step Model**. A "Flow" is essentially an array of [Step](file:///home/ravi/Desktop/Auto%20Job%20Apply/universal-browser-mcp/extension/entrypoints/background/record-replay/legacy-types.ts#228-253) objects.
- **Data Structure**: `Step[]`
- **Typing**: Types are defined in [legacy-types.ts](file:///home/ravi/Desktop/Auto%20Job%20Apply/universal-browser-mcp/extension/entrypoints/background/record-replay/legacy-types.ts) (e.g., [StepClick](file:///home/ravi/Desktop/Auto%20Job%20Apply/universal-browser-mcp/extension/entrypoints/background/record-replay/legacy-types.ts#50-56), [StepFill](file:///home/ravi/Desktop/Auto%20Job%20Apply/universal-browser-mcp/extension/entrypoints/background/record-replay/legacy-types.ts#57-62)).
- **Control Flow**: Very limited. Execution proceeds from index `i` to `i+1`.

### Features
- **Basic Actions**: `click`, `fill`, `scroll`, [wait](file:///home/ravi/Desktop/Auto%20Job%20Apply/universal-browser-mcp/extension/entrypoints/background/record-replay-v3/engine/kernel/runner.ts#418-426), [screenshot](file:///home/ravi/Desktop/Auto%20Job%20Apply/universal-browser-mcp/extension/entrypoints/background/record-replay-v3/engine/kernel/runner.ts#798-799).
- **Selectors**: Supports CSS, XPath, Text, Aria locators.
- **Simplicity**: Easy to parse and execute sequentially.

### Limitations
- **No Complex Logic**: Hard to implement conditions or operational loops without hacking "subflows" deeply.
- **Fragile**: If one step fails, the whole flow typically stops (unless simple retry logic is used).
- **Scalability**: Not designed for long-running or complex automation tasks.

---

## Deep Dive: Version 2 (Transitional/Current)

**Location**: `extension/entrypoints/background/record-replay` (mixed with V1 runner logic)
**Actions**: `extension/entrypoints/background/record-replay/actions`

### Architecture & Data Model
V2 introduces a **Directed Acyclic Graph (DAG)** model, though it still relies on some "control directive" concepts for complex flows.
- **Data Structure**: `nodes: NodeBase[]`, `edges: Edge[]`.
- **Execution Model**: Moves from Node to Node via Edges.
- **Control Flow**:
    - **Branching**: Supported via "Labelled Edges" (e.g., `true`/`false` paths).
    - **Loops**: Implemented via specific "Control Actions" like `foreach` and `while`. These are often "container" nodes that manage their own sub-execution.

### Key Features
- **Modular Actions**: Actions are defined in `actions/` directory.
- **Better State Management**: Explicit variable handling.
- **Backward Compatibility**: Often includes adapters or runs alongside V1 logic.

### Dependencies
- Shares `flow-runner.ts` and `flow-store.ts` with V1 logic in the `record-replay` directory.
- **Storage**: Uses standard `chrome.storage` or IndexedDB.

---

## Deep Dive: Version 3 (Next-Gen Engine)

**Location**: `extension/entrypoints/background/record-replay-v3`

### Architecture: The "Kernel" Approach
V3 represents a complete rewrite of the execution engine, moving away from simple scripts to a **Distributed-Ready Runtime Kernel**.

#### 1. Core Components (`engine/kernel`)
- **RunScheduler**: Manages a queue of runs. It doesn't just "run" a script; it schedules it.
- **RunRunner**: The execution unit. It traverses the graph node-by-node.
    - **True Graph Loops**: Unlike V2's `while` containers, V3 implements loops by simply having an edge point back to a previous node (Cycles in the Graph).
- **LeaseManager**: Implements a "locking" mechanism (`leasing`) for queue items. This prevents race conditions, especially if multiple background workers (or tabs) were to process the queue.

#### 2. Resilience & Recovery (`engine/recovery`)
- **Crash Recovery**: explicit `recoverFromCrash()` routine. If the browser crashes, V3 can inspect the storage/locks on restart and mark runs as failed or retry them.
- **Keepalive**: Uses `keepalive-manager` to ensure the Service Worker stays alive during long executions.

#### 3. Modularity & Plugins
- **PluginRegistry**: Nodes are not hardcoded. They are registered as plugins.
- **V2 Adapter**: It includes `registerV2ReplayNodesAsV3Nodes`, which wraps V2 actions to work inside the V3 engine.
    - *Note*: It explicitly **excludes** V2's `foreach` and `while` because V3 handles flow control natively via graph topology.

#### 4. Advanced Triggering (`engine/triggers`)
- Modular trigger system: `cron`, `interval`, `dom` (mutation observers), `url` (navigation), `contextMenu`.
- Triggers are managed objects, not just simple event listeners.

#### 5. Debugging & RPC
- **RPC Server**: Exposes an API for external agents (like the DevTools UI) to control execution (Pause, Resume, Step Over, Step Into).
- **Breakpoints**: First-class support for setting breakpoints on nodes.

### Data Model Differences
- **Run Records**: V3 maintains detailed `state` (paused, running, canceled) and `attempt` counts for every run interactively.
- **Storage Port**: Abstracts the database layer, allowing for potential backend swaps.

---

## Summary Comparison

| Feature | V1 (Legacy) | V2 (Current) | V3 (New Engine) |
| :--- | :--- | :--- | :--- |
| **Flow Structure** | Linear List | DAG + Control Containers | Pure Graph (Cyclic) |
| **Loops** | N/A (or hacky) | `foreach` / `while` Nodes | Graph Cycles (Edges) |
| **Execution State** | In-Memory only | In-Memory / Basic Persist | Storage-Backed (Crash Resilient) |
| **Concurrency** | unsafe | Basic | **Lease-based Locking** |
| **Debugging** | Logs only | Logs | **Breakpoints, Stepping, RPC** |
| **Triggers** | Basic Listeners | Integrated | **Manager System (Cron/DOM/etc)** |
| **Code Location** | `record-replay/legacy-types` | `record-replay/actions` | `record-replay-v3` |

### Dependency Chain
- **V3 depends on**: `keepalive-manager`, `native-host` (likely), `storage-manager`.
- **V2 depends on**: `record-replay/flow-store`.
- **V1 depends on**: `record-replay/flow-store`.

### Conclusion
**V3 is the robust, "Enterprise-Grade" evolution.** While V1/V2 were extensions scripts, V3 is a mini-operating system for automation tasks, handling scheduling, resource locking, and process recovery.
